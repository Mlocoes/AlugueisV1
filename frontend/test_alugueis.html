/**
 * Test de funcionalidad del m√≥dulo alugu√©is
 * Abre en el navegador: http://localhost:3000/test_alugueis.html
 */
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test M√≥dulo Alugu√©is</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>üß™ Test M√≥dulo Alugu√©is</h1>
        
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Controles de Test</h5>
                    </div>
                    <div class="card-body">
                        <button id="test-login" class="btn btn-primary me-2">1. Test Login</button>
                        <button id="test-anos" class="btn btn-secondary me-2">2. Test Anos</button>
                        <button id="test-modulo" class="btn btn-success me-2">3. Test M√≥dulo</button>
                        <button id="test-dropdowns" class="btn btn-warning">4. Test Dropdowns</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="test-ano-select" class="form-label">Ano Test</label>
                <select id="test-ano-select" class="form-select">
                    <option value="">Selecione o ano</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="test-mes-select" class="form-label">M√™s Test</label>
                <select id="test-mes-select" class="form-select" disabled>
                    <option value="">Selecione o m√™s</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Log de Resultados</h5>
                    </div>
                    <div class="card-body">
                        <pre id="test-log" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 0.25rem;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts necess√°rios -->
    <script src="js/utils/security.js"></script>
    <script src="js/apiService.js"></script>
    <script src="js/services/authService.js"></script>
    <script src="js/modules/alugueis.js"></script>

    <script>
        // Test setup
        let testLog = document.getElementById('test-log');
        let token = null;

        function log(message) {
            console.log(message);
            testLog.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
            testLog.scrollTop = testLog.scrollHeight;
        }

        // 1. Test Login
        document.getElementById('test-login').addEventListener('click', async () => {
            log('üîê Iniciando test de login...');
            
            try {
                const response = await fetch('http://localhost:8000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        usuario: 'admin',
                        senha: 'admin00'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    token = data.access_token;
                    log('‚úÖ Login realizado com sucesso');
                    log(`üîë Token: ${token.substring(0, 50)}...`);
                    
                    // Configurar apiService
                    if (window.apiService) {
                        window.apiService.setToken(token);
                        log('‚úÖ Token configurado no apiService');
                    }
                } else {
                    log('‚ùå Erro no login: ' + response.status);
                }
            } catch (error) {
                log('‚ùå Erro no login: ' + error.message);
            }
        });

        // 2. Test Anos
        document.getElementById('test-anos').addEventListener('click', async () => {
            log('üìÖ Testando endpoint de anos...');
            
            if (!token) {
                log('‚ùå Fa√ßa login primeiro');
                return;
            }

            try {
                if (window.apiService) {
                    const data = await window.apiService.getAnosDisponiveisAlugueis();
                    log('‚úÖ Dados de anos recebidos:');
                    log(JSON.stringify(data, null, 2));
                } else {
                    log('‚ùå ApiService n√£o dispon√≠vel');
                }
            } catch (error) {
                log('‚ùå Erro ao obter anos: ' + error.message);
            }
        });

        // 3. Test M√≥dulo
        document.getElementById('test-modulo').addEventListener('click', async () => {
            log('üè† Testando m√≥dulo alugu√©is...');
            
            try {
                if (window.alugueisModule) {
                    log('‚úÖ M√≥dulo alugu√©is encontrado');
                    log('üîß Inicializando m√≥dulo...');
                    
                    await window.alugueisModule.load();
                    log('‚úÖ M√≥dulo carregado com sucesso');
                } else {
                    log('‚ùå M√≥dulo alugu√©is n√£o encontrado em window.alugueisModule');
                }
            } catch (error) {
                log('‚ùå Erro no m√≥dulo: ' + error.message);
            }
        });

        // 4. Test Dropdowns
        document.getElementById('test-dropdowns').addEventListener('click', async () => {
            log('üìã Testando preenchimento de dropdowns...');
            
            if (!window.alugueisModule) {
                log('‚ùå Carregue o m√≥dulo primeiro');
                return;
            }

            try {
                // Simular elementos para teste
                const anoSelect = document.getElementById('test-ano-select');
                const mesSelect = document.getElementById('test-mes-select');
                
                if (anoSelect && mesSelect) {
                    // Monkeypatch para usar nossos elementos de teste
                    const originalGetElementById = document.getElementById;
                    document.getElementById = function(id) {
                        if (id === 'alugueis-ano-select') return anoSelect;
                        if (id === 'alugueis-mes-select') return mesSelect;
                        return originalGetElementById.call(document, id);
                    };

                    await window.alugueisModule.loadAnosDisponiveis();
                    log('‚úÖ Dropdowns populados');
                    
                    // Restaurar fun√ß√£o original
                    document.getElementById = originalGetElementById;
                }
            } catch (error) {
                log('‚ùå Erro nos dropdowns: ' + error.message);
            }
        });

        // Inicializa√ß√£o
        log('üöÄ Test ready! Fa√ßa login primeiro, depois teste os outros bot√µes.');
    </script>
</body>
</html>
