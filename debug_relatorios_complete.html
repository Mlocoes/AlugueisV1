<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Completo Relat√≥rios</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f8f9fa; }
        .debug-section { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #007bff; }
        .debug-section h3 { margin-top: 0; color: #007bff; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        button { background: #007bff; color: white; border: none; padding: 8px 15px; margin: 5px; cursor: pointer; border-radius: 4px; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .result { background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîç Debug Completo - Sistema de Relat√≥rios</h1>
    
    <div class="debug-section">
        <h3>1. Estado dos M√≥dulos Globais</h3>
        <button onclick="checkGlobalModules()">Verificar M√≥dulos</button>
        <div id="global-modules-result" class="result"></div>
    </div>
    
    <div class="debug-section">
        <h3>2. DOM Elements Check</h3>
        <button onclick="checkDOMElements()">Verificar Elementos DOM</button>
        <div id="dom-elements-result" class="result"></div>
    </div>
    
    <div class="debug-section">
        <h3>3. Event Listeners Check</h3>
        <button onclick="checkEventListeners()">Verificar Event Listeners</button>
        <div id="event-listeners-result" class="result"></div>
    </div>
    
    <div class="debug-section">
        <h3>4. API Calls Test</h3>
        <button onclick="testAPICalls()">Testar API</button>
        <div id="api-calls-result" class="result"></div>
    </div>
    
    <div class="debug-section">
        <h3>5. Simular Mudan√ßa de Filtros</h3>
        <button onclick="simulateFilterChange()">Simular Filtros</button>
        <div id="filter-simulation-result" class="result"></div>
    </div>
    
    <div class="debug-section">
        <h3>6. Console Log Viewer</h3>
        <button onclick="startConsoleCapture()">Capturar Console</button>
        <button onclick="stopConsoleCapture()">Parar Captura</button>
        <div id="console-logs" class="result" style="max-height: 300px; overflow-y: auto;"></div>
    </div>

    <script>
        let originalConsoleLog = console.log;
        let originalConsoleError = console.error;
        let originalConsoleWarn = console.warn;
        let capturing = false;
        let logBuffer = [];

        function checkGlobalModules() {
            const result = document.getElementById('global-modules-result');
            let html = '<h4>Estado dos M√≥dulos:</h4>';
            
            const modules = [
                'window.relatoriosManager',
                'window.relatoriosModule', 
                'window.apiService',
                'window.authService',
                'window.deviceManager',
                'window.uiManager',
                'window.viewManager'
            ];
            
            modules.forEach(module => {
                const exists = eval(module + ' !== undefined && ' + module + ' !== null');
                const type = exists ? typeof eval(module) : 'undefined';
                html += `<div class="${exists ? 'success' : 'error'}">
                    ${module}: ${exists ? '‚úÖ' : '‚ùå'} (${type})
                </div>`;
                
                if (exists && module.includes('relatorios')) {
                    const obj = eval(module);
                    if (obj && typeof obj === 'object') {
                        html += `<div class="info" style="margin-left: 20px;">
                            - Methods: ${Object.getOwnPropertyNames(Object.getPrototypeOf(obj)).filter(name => typeof obj[name] === 'function').join(', ')}<br>
                            - Properties: ${Object.keys(obj).join(', ')}
                        </div>`;
                    }
                }
            });
            
            result.innerHTML = html;
        }
        
        function checkDOMElements() {
            const result = document.getElementById('dom-elements-result');
            let html = '<h4>Elementos DOM:</h4>';
            
            const elements = [
                'relatorios-ano-select',
                'relatorios-mes-select',
                'relatorios-proprietario-select', 
                'relatorios-transferencias-check',
                'relatorios-table-body',
                'relatorios-alerts'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                html += `<div class="${element ? 'success' : 'error'}">
                    #${id}: ${element ? '‚úÖ Encontrado' : '‚ùå N√£o encontrado'}
                </div>`;
                
                if (element) {
                    html += `<div class="info" style="margin-left: 20px;">
                        Tag: ${element.tagName}, Class: "${element.className}"<br>`;
                    
                    if (element.tagName === 'SELECT') {
                        html += `Valor: "${element.value}", Op√ß√µes: ${element.options.length}<br>`;
                    }
                    
                    // Check event listeners
                    const listeners = getEventListeners ? getEventListeners(element) : {};
                    const listenerTypes = Object.keys(listeners);
                    html += `Event Listeners: ${listenerTypes.length > 0 ? listenerTypes.join(', ') : 'Nenhum'}<br>`;
                    
                    html += `</div>`;
                }
            });
            
            result.innerHTML = html;
        }
        
        function checkEventListeners() {
            const result = document.getElementById('event-listeners-result');
            let html = '<h4>Verifica√ß√£o de Event Listeners:</h4>';
            
            const elements = [
                'relatorios-ano-select',
                'relatorios-mes-select', 
                'relatorios-proprietario-select',
                'relatorios-transferencias-check'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    html += `<div class="info"><strong>#${id}:</strong><br>`;
                    
                    // Test if change event triggers
                    let triggered = false;
                    const testHandler = () => { triggered = true; };
                    
                    element.addEventListener('change', testHandler);
                    element.dispatchEvent(new Event('change'));
                    element.removeEventListener('change', testHandler);
                    
                    html += `- Event Trigger Test: ${triggered ? '‚úÖ Funcionando' : '‚ùå N√£o funciona'}<br>`;
                    
                    // Check if filterData method exists and works
                    if (window.relatoriosManager && typeof window.relatoriosManager.filterData === 'function') {
                        html += `- filterData() method: ‚úÖ Dispon√≠vel<br>`;
                    } else {
                        html += `- filterData() method: ‚ùå Indispon√≠vel<br>`;
                    }
                    
                    html += `</div>`;
                }
            });
            
            result.innerHTML = html;
        }
        
        async function testAPICalls() {
            const result = document.getElementById('api-calls-result');
            result.innerHTML = '<div class="info">üîÑ Testando APIs...</div>';
            let html = '<h4>Resultados das APIs:</h4>';
            
            const tests = [
                { name: 'Anos Dispon√≠veis', url: '/api/reportes/anos-disponiveis' },
                { name: 'Propriet√°rios', url: '/api/proprietarios/' },
                { name: 'Resumo Mensal', url: '/api/reportes/resumen-mensual' },
                { name: 'Extras/Reportes', url: '/api/extras/reportes' }
            ];
            
            for (const test of tests) {
                try {
                    const response = await fetch(`http://zeus.kronos.cloudns.ph:8000${test.url}`);
                    const data = await response.json();
                    
                    html += `<div class="${response.ok ? 'success' : 'error'}">
                        ${test.name}: ${response.ok ? '‚úÖ' : '‚ùå'} (${response.status})
                        ${Array.isArray(data) ? `- ${data.length} items` : ''}
                    </div>`;
                } catch (error) {
                    html += `<div class="error">
                        ${test.name}: ‚ùå Erro - ${error.message}
                    </div>`;
                }
            }
            
            result.innerHTML = html;
        }
        
        function simulateFilterChange() {
            const result = document.getElementById('filter-simulation-result');
            let html = '<h4>Simula√ß√£o de Mudan√ßa de Filtros:</h4>';
            
            // Test 1: Change ano filter
            const anoSelect = document.getElementById('relatorios-ano-select');
            if (anoSelect) {
                html += '<div class="info">Testando filtro de ano...</div>';
                
                // Add test option if needed
                if (anoSelect.options.length <= 1) {
                    const option = document.createElement('option');
                    option.value = '2025';
                    option.textContent = '2025';
                    anoSelect.appendChild(option);
                }
                
                anoSelect.value = '2025';
                anoSelect.dispatchEvent(new Event('change'));
                html += '<div class="success">‚úÖ Filtro de ano disparado</div>';
            }
            
            // Test 2: Change mes filter
            const mesSelect = document.getElementById('relatorios-mes-select');
            if (mesSelect) {
                html += '<div class="info">Testando filtro de m√™s...</div>';
                mesSelect.value = '8';
                mesSelect.dispatchEvent(new Event('change'));
                html += '<div class="success">‚úÖ Filtro de m√™s disparado</div>';
            }
            
            // Test 3: Manual filterData call
            if (window.relatoriosManager && typeof window.relatoriosManager.filterData === 'function') {
                html += '<div class="info">Testando chamada direta de filterData()...</div>';
                try {
                    window.relatoriosManager.filterData();
                    html += '<div class="success">‚úÖ filterData() executado</div>';
                } catch (error) {
                    html += `<div class="error">‚ùå Erro em filterData(): ${error.message}</div>`;
                }
            }
            
            result.innerHTML = html;
        }
        
        function startConsoleCapture() {
            if (capturing) return;
            capturing = true;
            logBuffer = [];
            
            console.log = function(...args) {
                logBuffer.push({type: 'log', args: args, time: new Date().toLocaleTimeString()});
                updateConsoleDisplay();
                originalConsoleLog.apply(console, args);
            };
            
            console.error = function(...args) {
                logBuffer.push({type: 'error', args: args, time: new Date().toLocaleTimeString()});
                updateConsoleDisplay();
                originalConsoleError.apply(console, args);
            };
            
            console.warn = function(...args) {
                logBuffer.push({type: 'warn', args: args, time: new Date().toLocaleTimeString()});
                updateConsoleDisplay();
                originalConsoleWarn.apply(console, args);
            };
            
            document.getElementById('console-logs').innerHTML = '<div class="info">üì° Captura ativa...</div>';
        }
        
        function stopConsoleCapture() {
            if (!capturing) return;
            capturing = false;
            
            console.log = originalConsoleLog;
            console.error = originalConsoleError;
            console.warn = originalConsoleWarn;
        }
        
        function updateConsoleDisplay() {
            const container = document.getElementById('console-logs');
            let html = '<h5>Console Logs:</h5>';
            
            logBuffer.slice(-50).forEach(log => {
                const className = log.type === 'error' ? 'error' : log.type === 'warn' ? 'warning' : 'info';
                html += `<div class="${className}">
                    [${log.time}] ${log.args.join(' ')}
                </div>`;
            });
            
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }
        
        // Auto-run initial checks
        window.onload = function() {
            setTimeout(() => {
                checkGlobalModules();
                checkDOMElements();
            }, 1000);
        };
    </script>
</body>
</html>
